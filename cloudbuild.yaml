steps:
  # build setting
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-rust-api-server-setting'
    args:
      - 'build'
      - '-t'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server-setting:latest'
      - '-t'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server-setting:$BRANCH_NAME-$REVISION_ID'
      - '--build-arg'
      - 'DIR_NAME=rust-api-server'
      - '--target'
      - 'setting'
      - '--cache-from'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server-setting:latest'
      - 'rust-api-server'
  # build rust-api-server
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-rust-api-server'
    args:
      - 'build'
      - '-t'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server:latest'
      - '-t'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server:$BRANCH_NAME-$REVISION_ID'
      - '--build-arg'
      - 'DIR_NAME=rust-api-server'
      - '--target'
      - 'setting'
      - '--cache-from'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server:latest'
      - '--cache-from'
      - 'us.gcr.io/${PROJECT_ID}/rust-api-server-setting:latest'
      - 'rust-api-server'
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-mongodb'
    args:
      - 'build'
      - '-t'
      - 'us.gcr.io/${PROJECT_ID}/mongodb:latest'
      - '-t'
      - 'us.gcr.io/${PROJECT_ID}/mongodb:$BRANCH_NAME-$REVISION_ID'
      - 'mongodb'
    waitFor:
      - '-'
images:
  - 'us.gcr.io/${PROJECT_ID}/mongodb:latest'
  - 'us.gcr.io/${PROJECT_ID}/mongodb:$BRANCH_NAME-$REVISION_ID'
  - 'us.gcr.io/${PROJECT_ID}/rust-api-server:latest'
  - 'us.gcr.io/${PROJECT_ID}/rust-api-server:$BRANCH_NAME-$REVISION_ID'
  - 'us.gcr.io/${PROJECT_ID}/rust-api-server-setting:latest'
  - 'us.gcr.io/${PROJECT_ID}/rust-api-server-setting:$BRANCH_NAME-$REVISION_ID'
